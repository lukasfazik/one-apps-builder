spec:
  inputs:
    image_name:
      description: "Name of the image to build"
      type: string
      default: "one-apps-builder"
    pipeline_type:
      description: "Type of pipeline to run"
      type: string
      default: "build-images"
      options:
        - "build-images"
        - "build-containers"
    distro_name:
      description: "Name of the distribution"
      type: string
      default: ""
    distro_versions:
      description: "Versions of the distribution"
      type: array
      default: [""]
    distro_editions:
      description: "Editions of the distribution"
      type: array
      default: [""]
---

variables:
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_SUBMODULE_FORCE_HTTPS: true
    
default:
  image: $CI_REGISTRY_IMAGE/$[[ inputs.image_name ]]

stages:
  - build-container
  - prepare-dependencies
  - build-images
  - deploy-images
  - delete-images

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"

.images:
  variables:
    INPUT_DIR: "one-apps"
    OUTPUT_DIR: "one-apps/export"
    PACKER_HEADLESS: "true"
  parallel:
    matrix:
    - DISTRO_NAME: $[[ inputs.distro_name ]]
      DISTRO_VER: $[[ inputs.distro_versions ]]
      DISTRO_EDITION: $[[ inputs.distro_editions ]]

build-container-job:
  rules:
    - if: '"$[[ inputs.pipeline_type ]]" == "build-containers"'
  variables:
    GIT_SUBMODULE_PATHS: ":(exclude)one-apps"
    IMAGE: $CI_REGISTRY_IMAGE/$[[ inputs.image_name ]]
  image:
    name: quay.io/podman/stable
    docker:
      user: podman
  stage: build-container
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | podman login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin
  script:
    - podman build -t "$IMAGE" .
    - podman push "$IMAGE"

build-addon-context-job:
  rules:
    - if: '"$[[ inputs.pipeline_type ]]" == "build-images"'
  stage: prepare-dependencies
  script:
    - make -C one-apps context-iso
  cache:
    key: context-$CI_PIPELINE_ID
    paths:
      - one-apps/context-*/out/*
      - one-apps/export/one-context.iso

download-virtio-drivers-job:
  rules:
    - if: '"$[[ inputs.pipeline_type ]]" == "build-images" && "$[[ inputs.distro_name ]]" == "windows"'
  stage: prepare-dependencies
  variables:
    VIRTIO_ISO_PATH: one-apps/packer/windows/iso/virtio-win.iso
  script:
    - curl -L -R -o "$VIRTIO_ISO_PATH" --time-cond "$VIRTIO_ISO_PATH" 'https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-virtio/virtio-win.iso'
  cache:
    key: virtio-drivers
    paths:
      - "$VIRTIO_ISO_PATH"

build-images-job:
  rules:
    - if: '"$[[ inputs.pipeline_type ]]" == "build-images"'
  stage: build-images
  extends: .images
  cache:
    - key: context-$CI_PIPELINE_ID
      paths:
        - one-apps/context-*/out/*
        - one-apps/export/one-context.iso 
    - key: virtio-drivers
      paths:
        - one-apps/packer/windows/iso/virtio-win.iso
  script:
    - make -C one-apps "${DISTRO_NAME}${DISTRO_VER}${DISTRO_EDITION}"

deploy-images-job:
  rules:
    - if: '"$[[ inputs.pipeline_type ]]" == "build-images"'
  stage: deploy-images
  script:
    - echo "Deploying images to Stratus FI..."
    - echo "Images successfully deployed."

delete-images-job:
  rules:
    - if: '"$[[ inputs.pipeline_type ]]" == "build-images"'
  stage: delete-images
  script:
    - echo "Removing VM template..."
    - echo "VM template removed successfully."
  when: manual
  manual_confirmation: 'Are you sure you want to delete the added template with images?'